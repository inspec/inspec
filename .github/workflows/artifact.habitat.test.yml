name: Test LTS-2024 Habitat Package Artifacts on PR

on:
  pull_request:
    branches:
      - inspec-5

env:
  BLDR_URL: 'https://bldr.habitat.sh/'
  HAB_ORIGIN: 'chef'
  HAB_AUTH_TOKEN: ${{ secrets.HAB_AUTH_TOKEN }}
  HABITAT_VERSION_SET: 'latest'
  CHEF_LICENSE: "accept-no-persist"
  HAB_LICENSE: "accept-no-persist"
  HAB_NONINTERACTIVE: "true"

permissions:
  contents: write

jobs:
  agent-matrix:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    runs-on: ${{ matrix.os }}
    steps:
      - name: Print OS
        run: echo "--- ${{ matrix.os }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install, Build, and Test Habitat Package (Linux)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        env:
          HAB_REFRESH_CHANNEL: "LTS-2024"
          HAB_BLDR_CHANNEL: "LTS-2024"
        run: |
          echo "--- Installing Habitat on Linux with version: $HABITAT_VERSION_SET"
          curl https://raw.githubusercontent.com/habitat-sh/habitat/master/components/hab/install.sh | sudo bash -s -- -v "$HABITAT_VERSION_SET" -t "x86_64-linux"
          hab license accept
          hab origin key download $HAB_ORIGIN
          hab origin key download --auth $HAB_AUTH_TOKEN --secret $HAB_ORIGIN
          hab pkg build .
          source results/last_build.env
          sudo hab license accept
          sudo hab pkg install -b results/$pkg_artifact
          export PATH="$(hab pkg path chef/inspec)/bin:$PATH"
          pushd "$PWD/test/artifact"
          rake

      - name: Install, Build, and Test Habitat Package (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        env:
          HAB_REFRESH_CHANNEL: "LTS-2024"
          HAB_BLDR_CHANNEL: "LTS-2024"
        run: |
          Write-Output "--- Installing Habitat on Windows with version: $env:HABITAT_VERSION_SET"
          $env:HAB_LICENSE = "accept-no-persist"
          Invoke-Expression "& { $(Invoke-RestMethod https://raw.githubusercontent.com/habitat-sh/habitat/main/components/hab/install.ps1) } -Version $env:HABITAT_VERSION_SET"
          $env:Path += ";C:\ProgramData\Habitat"
          hab license accept
          hab origin key download $env:HAB_ORIGIN
          hab origin key download --auth $env:HAB_AUTH_TOKEN --secret $env:HAB_ORIGIN
          hab pkg build .
          . results\last_build.ps1
          hab pkg install -b results\$pkg_artifact
          Write-Host "--- Downloading Ruby + DevKit"
          Invoke-WebRequest -Uri "https://github.com/oneclick/rubyinstaller2/releases/download/RubyInstaller-3.1.6-1/rubyinstaller-devkit-3.1.6-1-x64.exe" -OutFile "c:/rubyinstaller-devkit-3.1.6-1-x64.exe"
          
          Write-Host "--- Installing Ruby + DevKit"
          Start-Process c:\rubyinstaller-devkit-3.1.6-1-x64.exe -ArgumentList '/verysilent /allusers /dir=C:\\ruby316' -Wait
          
          Write-Host "--- Cleaning up installation"
          Remove-Item c:\rubyinstaller-devkit-3.1.6-1-x64.exe -Force
          
          $Env:Path += ";C:\ruby316\bin;C:\hab\bin"
          Write-Host "--- Running tests"
          Push-Location "test/artifact"
          rake