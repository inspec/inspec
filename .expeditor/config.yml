# Documentation available at https://expeditor.chef.io/docs/getting-started/
---

product_key: inspec


pipelines:
 - verify/private:
      definition: .expeditor/verify_private.pipeline.yml
      public: false
      description: Pull Request validation tests
      env:
      - LANG: "C.UTF-8"
      - SLOW: 1
      - NO_AWS: 1
      - MT_CPU: 5
 - omnibus/release:
    env:
     - EXPIRE_CACHE: 1
     - IGNORE_ARTIFACTORY_RUBY_PROXY: true # Artifactory is throwing 500's when downloading some gems like ffi.
 - omnibus/adhoc:
    definition: .expeditor/release.omnibus.yml
    env:
     - ADHOC: true
     - EXPIRE_CACHE: 1
     - IGNORE_ARTIFACTORY_RUBY_PROXY: true # Artifactory is throwing 500's when downloading some gems like ffi.
 - habitat/build:
    env:
     - HAB_NONINTERACTIVE: "true"
     - HAB_NOCOLORING: "true"
     - HAB_STUDIO_SECRET_HAB_NONINTERACTIVE: "true"
 - artifact/habitat:
    description: Execute tests against the habitat artifact
    definition: .expeditor/artifact.habitat.yml
    env:
     - HAB_NONINTERACTIVE: "true"
     - HAB_NOCOLORING: "true"
     - HAB_STUDIO_SECRET_HAB_NONINTERACTIVE: "true"
    trigger: pull_request

slack:
 notify_channel: inspec-notify

github:
 delete_branch_on_merge: true
 version_tag_format: v{{version}}
 minor_bump_labels:
   - "Expeditor: Bump Minor Version"
 # allow bumping the major release via label
 major_bump_labels:
   - "Expeditor: Bump Major Version"

release_branches:
  - inspec-6:
     version_constraint: 6.*
  - main:
      version_constraint: 5.*

changelog:
 categories:
  - "Type: New Resource": "New Resources"
  - "Type: New Feature": "New Features"
  - "Type: Enhancement": "Enhancements"
  - "Type: Bug": "Bug Fixes"

subscriptions:
  - workload: pull_request_merged:{{github_repo}}:{{release_branch}}:*
    actions:
     - built_in:bump_version:
        ignore_labels:
         - "Expeditor: Skip All"
         - "Expeditor: Skip Version Bump"
        only_if_modified:
         - .expeditor/*
         - docs-chef-io/*
         - etc/*
         - habitat/*
         - inspec-bin/*
         - lib/*
         - omnibus/*
         - support/*
         - tasks/*
         - test/*
         - Gemfile*
         - LICENSE
         - "*.gemspec"
         - "*.md"
     - bash:.expeditor/update_version.sh:
        only_if: built_in:bump_version
     - built_in:update_changelog:
        ignore_labels:
         - "Expeditor: Skip All"
         - "Expeditor: Skip Changelog"
     - trigger_pipeline:artifact/habitat:
        only_if: built_in:bump_version
        ignore_labels:
         - "Expeditor: Skip Habitat"
         - "Expeditor: Skip All"
     - trigger_pipeline:omnibus/release:
        only_if: built_in:bump_version
        ignore_labels:
         - "Expeditor: Skip Omnibus"
         - "Expeditor: Skip All"
     - trigger_pipeline:habitat/build:
        only_if: built_in:bump_version
        ignore_labels:
         - "Expeditor: Skip Habitat"
         - "Expeditor: Skip All"
  - workload: artifact_published:current:inspec:{{version_constraint}}
    actions:
     - built_in:promote_habitat_packages
  - workload: pull_request_opened:{{github_repo}}:{{release_branch}}:*
    actions:
     - post_github_comment:.expeditor/templates/pull_request.mustache:
        ignore_team_members:
         - inspec/owners
         - inspec/inspec-core-team
     - built_in:github_auto_assign_author:
        only_if_team_member:
         - inspec/owners
         - inspec/inspec-core-team
