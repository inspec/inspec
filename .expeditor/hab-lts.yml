---
expeditor:
  secrets:
    PIPELINE_HAB_AUTH_TOKEN:
      path: account/static/habitat/chef-ci
      field: auth_token # Production Builder
      # acceptance_auth_token = acceptance
  accounts:
    - aws/chef-cd
  defaults:
    buildkite:
      timeout_in_minutes: 45
      env:
        HAB_ORIGIN: "chef"
        PIPELINE_HAB_BLDR_URL: "https://bldr.habitat.sh"
        # Necessary to prevent old studios from poisoning builds after core plans refreshes
        HAB_STUDIO_SECRET_HAB_NONINTERACTIVE: "true"
        HAB_STUDIO_SECRET_HAB_PREFER_LOCAL_CHEF_DEPS: "true"
        HAB_STUDIO_SECRET_HAB_REFRESH_CHANNEL: "LTS-2024"
        HAB_REFRESH_CHANNEL: "LTS-2024"
        HAB_BLDR_CHANNEL: "LTS-2024"
        HAB_NOCOLORING: "true"
        HAB_NONINTERACTIVE: "true"   

steps:

  - label: ":habicat: inspec (x86_64-linux)"
    command:
      - .expeditor/scripts/hab-lts.sh

    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux
            - HAB_LICENSE="accept-no-persist"
            - HAB_STUDIO_SECRET_HAB_NONINTERACTIVE="true"
            - HAB_STUDIO_SECRET_HAB_PREFER_LOCAL_CHEF_DEPS="true"
            - HAB_STUDIO_SECRET_HAB_REFRESH_CHANNEL="LTS-2024"
            - HAB_REFRESH_CHANNEL="LTS-2024"
            - HAB_BLDR_CHANNEL="LTS-2024"
            - HAB_NOCOLORING="true"
            - HAB_NONINTERACTIVE="true"
            - PLAN_CONTEXT="./habiat"
            - PIPELINE_HAB_AUTH_TOKEN="${PIPELINE_HAB_AUTH_TOKEN}"


  # - label: ":habicat: inspec (x86_64-windows)"
  #   command:
  #     - .expeditor/scripts/hab-lts.ps1

  #   expeditor:
  #     executor:
  #       docker:
  #         privileged: true
  #         environment:
  #           - BUILD_PKG_TARGET=x86_64-windows
  #           - HAB_LICENSE="accept-no-persist"
  #           - HAB_STUDIO_SECRET_HAB_NONINTERACTIVE="true"
  #           - HAB_STUDIO_SECRET_HAB_PREFER_LOCAL_CHEF_DEPS="true"
  #           - HAB_STUDIO_SECRET_HAB_REFRESH_CHANNEL="LTS-2024"
  #           - HAB_REFRESH_CHANNEL="LTS-2024"
  #           - HAB_BLDR_CHANNEL="LTS-2024"
  #           - HAB_NOCOLORING="true"
  #           - HAB_NONINTERACTIVE="true"
  #           - PLAN_CONTEXT="./habiat"
  #           - PIPELINE_HAB_AUTH_TOKEN="${PIPELINE_HAB_AUTH_TOKEN}"